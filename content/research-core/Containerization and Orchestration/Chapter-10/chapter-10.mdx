---
title: "Chapter 10: Manage containers"
description: 
date: "2024-04-02"
parent: "Redhat Enterprise Linux 9 - EX200 RHCSA"
grand_parent : null
order: 10
---

- A place to pull base images is called Image Repository or Container Repository (quay,docker hub, registry redhat). 

# Creating a container

### Install Required Software & provide container command access to a normal user
```bash
# This installes container engine (podman)
[root@server ~]# yum -y install container-tools 
[root@server ~]# loginctl enable-linger student 

```

### Configure Container Registries / Image Registries
```bash
# If you are a root user
[root@server ~]# vim /etc/containers/registries.conf
unqualified-search-registries = ["registry.access.redhat.com", "registry.redhat.io", "docker.io"]
[[registry]]
insecure = false
blocked = false
location = "docker.io"

# If you are a normal user
[sanjeeb@server ~]$ vim /home/sanjeeb/.config/containers/registries.conf
unqualified-search-registries = ["registry.access.redhat.com", "registry.redhat.io", "docker.io","quay.io"]
[[registry]]
insecure = true
blocked = false
location = "docker.io"
```

# Login 
```bash 
# login docker.io
[student@server containers]$ podman login docker.io 
Username: sanjeebkc             
Password: 
Login Succeeded!
```

# Search images 
```bash 
[student@server ~]$ podman search httpd 
NAME                              DESCRIPTION
docker.io/library/httpd           The Apache HTTP Server Project
docker.io/manageiq/httpd          Container with httpd, built on CentOS for Ma...
docker.io/paketobuildpacks/httpd  
docker.io/dockerpinata/httpd      
docker.io/jitesoft/httpd          Apache httpd on Alpine linux.
docker.io/vulhub/httpd     
...
```

# Pull images 
```bash 
[student@server ~]$ podman image pull docker.io/library/httpd
Trying to pull docker.io/library/httpd:latest...
Getting image source signatures
Copying blob 14c9d9d19932 done   | 
Copying blob 0ffcdbb5bd41 done   | 
Copying blob f5db40045454 done   | 
Copying blob 4f4fb700ef54 done   | 
Copying blob ac0ad684e55d done   | 
Copying blob b59792d2b7f1 done   | 
Copying config a3e79aafef done   | 
Writing manifest to image destination
a3e79aafef7f07a3a11d94f546220d8189719a5143d4bbda9568e48ffbac4a9d
```

# Inspect the image 
```bash 
[student@server ~]$ podman image inspect docker.io/library/httpd:latest 
[
     {
          "Id": "a3e79aafef7f07a3a11d94f546220d8189719a5143d4bbda9568e48ffbac4a9d",
          "Digest": "sha256:4c635dd2d5be0bd6bfd811eaf621e74cdbc4a9c6f94fff2a1157b47b8207776c",
          "RepoTags": [
               "docker.io/library/httpd:latest"
          ],
          ...
          "ExposedPorts": {
                    "80/tcp": {}
            },
     }
]
```

# Running a Container 
```bash 
[student@server ~]$ podman run -d --name testweb -p 1234:80 docker.io/library/httpd:latest
0fa62a75a3f73893d0a939fd278818c8d9c3153b47eac0207dea46da6ef999b4

[student@server ~]$ podman ps 
CONTAINER ID  IMAGE                           COMMAND           CREATED        STATUS        PORTS                         NAMES
0fa62a75a3f7  docker.io/library/httpd:latest  httpd-foreground  4 seconds ago  Up 4 seconds  0.0.0.0:1234->80/tcp, 80/tcp  testweb

# To find the location of index.html 
[root@server ~]# podman exec -it wwwserver bash 
root@150db1ba4d20:/usr/local/apache2# 

# Find the configuration file 
root@0fa62a75a3f7:/usr/local/apache2# find / -name httpd.conf
find: '/proc/tty/driver': Permission denied
find: '/proc/3/map_files': Permission denied
find: '/proc/4/map_files': Permission denied
find: '/proc/7/map_files': Permission denied
/usr/local/apache2/conf/httpd.conf
/usr/local/apache2/conf/original/httpd.conf

# Then search DocumentRoot in httpd.conf
root@0fa62a75a3f7:/usr/local/apache2# grep DocumentRoot /usr/local/apache2/conf/original/httpd.conf
# DocumentRoot: The directory out of which you will serve your
DocumentRoot "/usr/local/apache2/htdocs"
    # access content that does not live under the DocumentRoot.

root@0fa62a75a3f7:/usr/local/apache2/htdocs# ls
index.html
root@0fa62a75a3f7:/usr/local/apache2/htdocs# pwd
/usr/local/apache2/htdocs
```

# Building a custom image 
```bash 
[student@server ~]$ vim index.html 
[student@server ~]$ cat index.html 
<h1>This is a website ! </h1>

[student@server ~]$ cat Containerfile 
FROM docker.io/library/httpd
MAINTAINER student@example.com
COPY ./index.html /usr/local/apache2/htdocs

[student@server ~]$ podman build -t customhttpd .
STEP 1/3: FROM docker.io/library/httpd
Trying to pull docker.io/library/httpd:latest...
Getting image source signatures
Copying blob 0ffcdbb5bd41 done   | 
Copying blob 14c9d9d19932 done   | 
Copying blob 4f4fb700ef54 done   | 
Copying blob f5db40045454 done   | 
Copying blob ac0ad684e55d done   | 
Copying blob b59792d2b7f1 done   | 
Copying config a3e79aafef done   | 
Writing manifest to image destination
STEP 2/3: MAINTAINER student@example.com
--> 8436a30585e6
STEP 3/3: COPY ./index.html /usr/local/apache2/htdocs
COMMIT customhttpd
--> 70be5a22d81b
Successfully tagged localhost/customhttpd:latest
70be5a22d81b486944e5b1de303172936c77bf536c2b8c59bb783f05003d3192

# docker.io/library/httpd is base image and localhost/customhttpd is custom image
[student@server ~]$ podman images 
REPOSITORY               TAG         IMAGE ID      CREATED        SIZE
localhost/customhttpd    latest      70be5a22d81b  4 minutes ago  182 MB
docker.io/library/httpd  latest      a3e79aafef7f  2 months ago   182 MB
```

# Running a container 
```bash 
[student@server ~]$ podman run -d --name newweb -p 7788:80 localhost/customhttpd:latest 
97f5cce875acc13144de859dc63d244944ec2a5ec2be962c73d3781f8ea2b7e8

[student@server ~]$ podman ps 
CONTAINER ID  IMAGE                         COMMAND           CREATED        STATUS        PORTS                         NAMES
97f5cce875ac  localhost/customhttpd:latest  httpd-foreground  3 seconds ago  Up 3 seconds  0.0.0.0:7788->80/tcp, 80/tcp  newweb

# Testing the container 
[student@server ~]$ hostname -I 
192.168.208.138 
[student@server ~]$ curl 192.168.208.138:7788
<h1>This is a website ! </h1>
```

# Create a container with local persistent storage 
```bash

[student@server ~]$ podman run -d --name wwwserver -p 7788:80 -v /home/student/webdata/htdocs:/usr/local/apache2/htdocs:Z localhost/customhttpd:latest  
2ba748076220be7536cda237364998aebe87d7074734153c0547d20bb68605d4
[student@server ~]$ 
[student@server ~]$ podman ps 
CONTAINER ID  IMAGE                         COMMAND           CREATED        STATUS        PORTS                         NAMES
2ba748076220  localhost/customhttpd:latest  httpd-foreground  2 seconds ago  Up 3 seconds  0.0.0.0:7788->80/tcp, 80/tcp  wwwserver

# Testing
[student@server ~]$ hostname -I 
192.168.208.138 
[student@server ~]$ curl 192.168.208.138:7788
<h1>This web storage exist in local storage !</h1>

```

# Manage Container as a service 
```bash
[student@server user]$ pwd
/home/student/.config/systemd/user

[student@server user]$ podman generate systemd --name customhttpdcontainer --files --new 
DEPRECATED command:
It is recommended to use Quadlets for running containers and pods under systemd.
Please refer to podman-systemd.unit(5) for details.
/home/student/.config/systemd/user/container-customhttpdcontainer.service

[student@server user]$ ls
container-customhttpdcontainer.service

[student@server user]$ systemctl --user enable container-customhttpdcontainer.service
[student@server user]$ systemctl --user start container-customhttpdcontainer.service
```

## Failure Occured
The error Failed to connect to bus: No medium found indicates that systemctl --user commands cannot connect 
to the user-level systemd bus, likely because the user session is not being managed by systemd. To resolve 
this issue, follow these steps:
#### Step 1: Start a systemd User Session
Ensure that a systemd user session is running by manually starting it:
```bash 
[student@server user]$ /usr/lib/systemd/systemd --user &
```
#### Step 2: Set XDG_RUNTIME_DIR (if needed)
If the XDG_RUNTIME_DIR environment variable is not set, it can cause issues when trying to use systemctl 
--user. Check if it's set with:
```bash
[student@server user]$ echo $XDG_RUNTIME_DIR
[student@server user]$ export XDG_RUNTIME_DIR=/run/user/$(id -u)
```
#### Step 3: Reload the Daemon and Start the Service
After starting the systemd user instance and setting the runtime directory, try reloading the daemon and starting the service again:
```bash
[student@server user]$ systemctl --user daemon-reload
```